<html>
    <head>
        <title>Tic Tac Toe</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="../assets/js/jquery.js" type="text/javascript"></script>
        <script type="text/javascript">
            var game = function (element) {
                var players = ['X', 'O'];
                var ele = $(element);
                var boxes = ele.children();
                var $this = this;
                var board = new Array(9);
                var turn = 'X';
                var winner = null;
                var choice;
                var performance = 0;

//                var playerNum = 1;

                this.init = function () {
                    boxes.empty();
//                    $this.shufflePlayers();
                    $this.attachEventHandlers();
                    if ($this.getRandomBoolean()) {
                        $this.botTurn();
                    }
                };

                this.attachEventHandlers = function () {
                    boxes.unbind();
                    boxes.click(function (e) {
                        var box = $(this);
                        var ind = box.index();
                        if ($this.isEmpty(ind)) {
                            board[ind] = turn;
                            turn = $this.getEnemy();
                            box.text(board[ind]);
                            $this.checkWin();

                            if (e.clientX) {
                                $this.botTurn();
                            }

                        }
                    });
                };

                this.checkWin = function () {
                    Utility.printMatrix(board);
                    winner = $this.checkWinLogic(board);

                    if (winner) {
                        boxes.unbind();
                        if (Utility.askUser("Winner: " + winner + ". Restart Game?"))
                            $this.restartGame();
                    }
                    $this.checkTie();
                };

                this.isBoardFull = function () {
                    for (var i = 0; i < board.length; i++)
                        if ($this.isEmpty(i)) {
                            return false;
                        }
                    return true;
                };

                this.checkTie = function () {
                    if ($this.isBoardFull()) {
                        boxes.unbind();
                        if (Utility.askUser("No winner: Khichadi. Restart Game?"))
                            $this.restartGame();
                    }
                };

                this.restartGame = function () {
//                    board = new Array(9);
//                    turn = 0;
//                    winner = null;
//                    $this.init();
                    window.location.reload();
                };

                this.isEmpty = function (index) {
                    if (typeof board[index] == "undefined") {
                        return true;
                    }
                    return false;
                };

                this.makeEmpty = function (index) {
                    board[index] = undefined;
                };

                this.botTurn = function () {
                    performance = 0;
                    choice = null;
                    console.time("Time");
                    var $box = ele.children().eq(getBestChance()).click();
                    console.log("Number of Iterations: ", performance);
                    console.timeEnd("Time");

                    function getBestChance() {
                        $this.miniMax(turn, 0);
                        console.log('choice ', choice);
                        return choice;
//                        return choice.split("-")[1];
                    }

                };

                this.getEnemy = function (p) {
                    if (typeof p == "undefined") {
                        p = turn;
                    }
                    return p == 'X' ? 'O' : 'X';
                };

                this.shufflePlayers = function () {
                    var tempIndex = $this.getRandomBoolean();
                    turn = players[tempIndex];
                };

                this.getRandomBoolean = function () {
                    return Math.floor(Math.random() * 2);
                };

                this.checkWinLogic = function (arr) {
                    var winner = null;
                    if (arr[0] == arr[1] && arr[1] == arr[2] && arr[0] != null)
                        winner = arr[0];
                    if (arr[3] == arr[4] && arr[4] == arr[5] && arr[3] != null)
                        winner = arr[3];
                    if (arr[6] == arr[7] && arr[7] == arr[8] && arr[6] != null)
                        winner = arr[6];
                    if (arr[0] == arr[3] && arr[3] == arr[6] && arr[0] != null)
                        winner = arr[0];
                    if (arr[1] == arr[4] && arr[4] == arr[7] && arr[1] != null)
                        winner = arr[1];
                    if (arr[2] == arr[5] && arr[5] == arr[8] && arr[2] != null)
                        winner = arr[2];
                    if (arr[0] == arr[4] && arr[4] == arr[8] && arr[0] != null)
                        winner = arr[0];
                    if (arr[2] == arr[4] && arr[4] == arr[6] && arr[2] != null)
                        winner = arr[2];
                    return winner;
                };

                this.miniMax = function (tempTurn, depth) {
                    performance++;
                    var calcPoints = checkWinner();
//                    console.log(calcPoints)
                    if (typeof calcPoints != "undefined") {
                        return calcPoints;
                    }

                    var min = 99999, max = -99999;

                    for (var i = 0; i < 9; i++) {
                        if ($this.isEmpty(i)) {

                            if (tempTurn == turn) {
                                board[i] = tempTurn;
                                var currentScore = this.miniMax($this.getEnemy(tempTurn), depth + 1);
                                max = Math.max(currentScore, max);

                                if (depth == 0) {
                                    console.log("Score for position " + i + " = " + currentScore);
                                }
                                if (currentScore >= 0) {
                                    if (depth == 0) {
                                        choice = i;
                                    }
                                }
                                if (currentScore == 1) {
                                    $this.makeEmpty(i);
                                    break;
                                }
                                if (i == board.length - 1 && max < 0) {
                                    if (depth == 0) {
                                        choice = i;
                                    }
                                }
                            } else if (tempTurn == $this.getEnemy(turn)) {
                                board[i] = tempTurn;
                                var currentScore = this.miniMax($this.getEnemy(tempTurn), depth + 1);
                                min = Math.min(currentScore, min);
                                if (min == -1) {
                                    $this.makeEmpty(i);
                                    break;
                                }
                            }
                            $this.makeEmpty(i);
                        }
                    }

                    return tempTurn == turn ? max : min;

                    function checkWinner() {
                        var winner = $this.checkWinLogic(board);
                        if (winner == turn) {
                            return 1;
                        }
                        else if (winner == $this.getEnemy(turn)) {
                            return -1;
                        }
                        else if ($this.isBoardFull()) {
                            return 0;
                        }
                    }

                };

                this.init();

            };

            var ticTac;

            $(function () {
                ticTac = new game('#abc');
            });


            var Utility = {
                printMatrix: function (arr) {
                    console.log('Array: ');
                    for (i = 0; i < 3; i++) {
                        var m = arr[i * 3 + 0] ? arr[i * 3 + 0] : ' ';
                        var l = arr[i * 3 + 1] ? arr[i * 3 + 1] : ' ';
                        var n = arr[i * 3 + 2] ? arr[i * 3 + 2] : ' ';
                        console.log(m + ' , ' + l + ' , ' + n);
                    }
                },
                askUser: function (str)
                {
                    return window.confirm(str);
                }
            };





        </script>
        <style>
            ul.container{overflow: hidden; width: 306px; margin: auto; list-style: none;}
            ul.container li{float: left; width: 100px;  font-size: 30px; line-height: 100px; height: 100px; text-transform: uppercase; text-align: center; border: 1px solid #000; font-weight: bold; cursor: pointer; }
        </style>
    </head>
    <body>
        <ul class="container" id="abc">
            <li>X</li>
            <li>X</li>
            <li>X</li>
            <li>o</li>
            <li>X</li>
            <li>X</li>
            <li>X</li>
            <li>X</li>
            <li>X</li>
        </ul>
    </body>
</html>
